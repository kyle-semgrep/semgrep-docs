"use strict";(self.webpackChunkmegadocs=self.webpackChunkmegadocs||[]).push([[73625],{23504:(e,r,s)=>{s.d(r,{A:()=>o});const o=s.p+"assets/images/semgrep-workflow-require-pass-2a6373335f0ade0a9a04da33bd8c1708.png"},28453:(e,r,s)=>{s.d(r,{R:()=>n,x:()=>a});var o=s(96540);const i={},t=o.createContext(i);function n(e){const r=o.useContext(t);return o.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:n(e.components),o.createElement(t.Provider,{value:r},e.children)}},41729:(e,r,s)=>{s.d(r,{A:()=>o});const o=s.p+"assets/images/semgrep-workflow-actions-access-30bfce5e0ee2d5356f04c858233aacfc.png"},48602:(e,r,s)=>{s.d(r,{A:()=>o});const o=s.p+"assets/images/semgrep-workflow-pr-example-2fa378aa2472c90051588cc63b4b4a87.png"},70441:(e,r,s)=>{s.d(r,{A:()=>o});const o=s.p+"assets/images/semgrep-workflow-repository-rulesets-1b97b8e52dbc85854ab26c6f5e84b095.png"},75649:(e,r,s)=>{s.r(r),s.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>n,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"kb/semgrep-ci/github-repository-rulesets-semgrep","title":"Use GitHub repository rulesets to implement Semgrep","description":"Set up GitHub repository rulesets to implement Semgrep scans across many repositories in an organization.","source":"@site/docs/kb/semgrep-ci/github-repository-rulesets-semgrep.md","sourceDirName":"kb/semgrep-ci","slug":"/kb/semgrep-ci/github-repository-rulesets-semgrep","permalink":"/docs/kb/semgrep-ci/github-repository-rulesets-semgrep","draft":false,"unlisted":false,"editUrl":"https://github.com/kyle-semgrep/semgrep-docs/edit/main?base=kyle-semgrep:main/docs/kb/semgrep-ci/github-repository-rulesets-semgrep.md","tags":[{"inline":true,"label":"GitHub","permalink":"/docs/tags/git-hub"},{"inline":true,"label":"Repository rulesets","permalink":"/docs/tags/repository-rulesets"}],"version":"current","lastUpdatedAt":1752253235000,"frontMatter":{"tags":["GitHub","Repository rulesets"],"description":"Set up GitHub repository rulesets to implement Semgrep scans across many repositories in an organization."},"sidebar":"kbSidebar","previous":{"title":"Failed to run a git command during a pull request or merge request scan","permalink":"/docs/kb/semgrep-ci/git-command-errors"},"next":{"title":"Set up reusable GitHub workflows for Semgrep scans","permalink":"/docs/kb/semgrep-ci/github-reusable-workflows-semgrep"}}');var i=s(74848),t=s(28453);const n={tags:["GitHub","Repository rulesets"],description:"Set up GitHub repository rulesets to implement Semgrep scans across many repositories in an organization."},a="Use GitHub repository rulesets to implement Semgrep",l={},c=[{value:"Set up the central Semgrep scan workflow",id:"set-up-the-central-semgrep-scan-workflow",level:2},{value:"Behavior with bot-initiated commits",id:"behavior-with-bot-initiated-commits",level:3},{value:"Recommended configuration with merge queues",id:"recommended-configuration-with-merge-queues",level:3},{value:"Configure repository workflow access",id:"configure-repository-workflow-access",level:2},{value:"Configure an organization secret",id:"configure-an-organization-secret",level:2},{value:"Create an organization ruleset",id:"create-an-organization-ruleset",level:2},{value:"Verify by creating a pull request",id:"verify-by-creating-a-pull-request",level:2},{value:"Limitations",id:"limitations",level:2}];function u(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"use-github-repository-rulesets-to-implement-semgrep",children:"Use GitHub repository rulesets to implement Semgrep"})}),"\n",(0,i.jsxs)(r.p,{children:["Use ",(0,i.jsx)(r.a,{href:"https://docs.github.com/en/enterprise-cloud@latest/repositories/configuring-branches-and-merges-in-your-repository/managing-rulesets/creating-rulesets-for-a-repository#introduction",children:"GitHub repository rulesets"})," to quickly implement Semgrep scans across hundreds or thousands of repositories in your GitHub organization."]}),"\n",(0,i.jsxs)(r.p,{children:["Repository rulesets allow you to add a Semgrep scan as a workflow that is ",(0,i.jsx)(r.a,{href:"https://docs.github.com/en/enterprise-cloud@latest/repositories/configuring-branches-and-merges-in-your-repository/managing-rulesets/available-rules-for-rulesets#require-workflows-to-pass-before-merging",children:"required for pull requests to pass before merging"}),". Formerly, this feature was called ",(0,i.jsx)(r.a,{href:"https://github.blog/changelog/2023-08-02-github-actions-required-workflows-will-move-to-repository-rules/",children:"required workflows"}),"."]}),"\n",(0,i.jsx)(r.p,{children:"Repository rulesets use a centralized workflow file to execute the Semgrep scan action, meaning you can run scans on pull requests in as many repositories as desired by creating a single file."}),"\n",(0,i.jsx)(r.h2,{id:"set-up-the-central-semgrep-scan-workflow",children:"Set up the central Semgrep scan workflow"}),"\n",(0,i.jsxs)(r.p,{children:["To use the Semgrep workflow in other repositories owned by your organization, you can create a new repository in the organization with the Semgrep workflow file, or add it to an existing repository where you store common workflows. This example describes creating the workflow in a new repository called ",(0,i.jsx)(r.code,{children:"semgrep-workflow"}),"."]}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["Create a new repository following the ",(0,i.jsx)(r.a,{href:"https://docs.github.com/en/get-started/quickstart/create-a-repo",children:"GitHub documentation"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Name the repository ",(0,i.jsx)(r.code,{children:"semgrep-workflow"}),"."]}),"\n",(0,i.jsx)(r.li,{children:"Choose the repository visibility that matches the widest visibility of the repositories you want to run the workflow in. For example, if you want to run Semgrep on public, internal, and private repositories, the repository containing the workflow file must be public."}),"\n",(0,i.jsxs)(r.li,{children:["Add the Semgrep workflow file to the repository at ",(0,i.jsx)(r.code,{children:".github/workflows/semgrep.yml"}),". You can use the ",(0,i.jsx)(r.a,{href:"/semgrep-ci/sample-ci-configs/#sample-github-actions-configuration-file",children:"sample configuration"})," provided in the documentation, or a ",(0,i.jsx)(r.a,{href:"/deployment/customize-ci-jobs",children:"custom configuration"}),"."]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Semgrep repository with workflow file",src:s(84521).A+"",width:"1230",height:"550"})}),"\n",(0,i.jsx)(r.p,{children:"This example repository is internal, so it can only be used to store workflows that run on internal and private repositories."}),"\n",(0,i.jsx)(r.h3,{id:"behavior-with-bot-initiated-commits",children:"Behavior with bot-initiated commits"}),"\n",(0,i.jsxs)(r.p,{children:["The default Semgrep GitHub Actions configuration excludes any PRs or commits from GitHub's ",(0,i.jsx)(r.code,{children:"dependabot"})," to prevent permissions errors. If you have other bots or automations active in your organization's workflows, consider excluding these bots as well. Otherwise, the action may error due to bot permissions, or it may simply not be useful to run a Semgrep scan on changes made by an automation. For example, to exclude both ",(0,i.jsx)(r.code,{children:"dependabot"})," and other GitHub Actions, include:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"if: github.actor != 'dependabot[bot]' && github.actor != 'github-actions'\n"})}),"\n",(0,i.jsx)(r.h3,{id:"recommended-configuration-with-merge-queues",children:"Recommended configuration with merge queues"}),"\n",(0,i.jsxs)(r.p,{children:["If you use ",(0,i.jsx)(r.a,{href:"https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/configuring-pull-request-merges/managing-a-merge-queue",children:"merge queues"})," for repositories scanned with this workflow, your config must include ",(0,i.jsx)(r.code,{children:"merge_group"})," as a trigger in the ",(0,i.jsx)(r.code,{children:"on:"})," block. Otherwise, ",(0,i.jsx)(r.a,{href:"https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/configuring-pull-request-merges/managing-a-merge-queue#triggering-merge-group-checks-with-github-actions",children:"the workflow cannot run in the merge queue"})," and can block the queue."]}),"\n",(0,i.jsxs)(r.p,{children:["Unlike for ",(0,i.jsx)(r.code,{children:"pull_request"})," event types, Semgrep does not have any automatic configuration to run diff-aware scans on ",(0,i.jsx)(r.code,{children:"merge_group"})," events, so additional configuration is needed to run diff-aware scans in this environment. The most straightforward solution is to configure the workflow to be skipped during the merge group check, since the primary goal of a Semgrep diff-aware scan is to inform the developer ",(0,i.jsx)(r.strong,{children:"before"})," merging if they are introducing security issues."]}),"\n",(0,i.jsxs)(r.p,{children:["With the recommended alterations and removal of event types that do not occur with repository rulesets, the ",(0,i.jsx)(r.a,{href:"/docs/semgrep-ci/sample-ci-configs/#sample-github-actions-configuration-file",children:"sample configuration"})," would look like this:"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"name: Semgrep\n\non:\n  pull_request: {}\n  workflow_dispatch: {}\n  merge_group:\n    types: [checks_requested]\n\njobs:\n  semgrep:\n    name: semgrep/ci\n    runs-on: ubuntu-latest\n\n    container:\n      image: semgrep/semgrep\n\n    # Skip any PR created by dependabot and any check triggered by merge group\n    if: (github.actor != 'dependabot[bot]') && (github.event != 'merge_group')\n\n    steps:\n      - uses: actions/checkout@v4\n      - run: semgrep ci\n        env:\n          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"configure-repository-workflow-access",children:"Configure repository workflow access"}),"\n",(0,i.jsx)(r.p,{children:"The repository containing the Semgrep workflow must allow access to workflows from other repositories in the organization."}),"\n",(0,i.jsx)(r.p,{children:"To configure access:"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["In the repository containing the Semgrep workflow, click ",(0,i.jsx)(r.strong,{children:"Settings > Actions > General"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["In the ",(0,i.jsx)(r.strong,{children:"Access"})," section, select one of the ",(0,i.jsx)(r.strong,{children:"Accessible from"})," options to make the repository workflows accessible to your organization."]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Repository workflow access",src:s(41729).A+"",width:"1748",height:"738"})}),"\n",(0,i.jsx)(r.h2,{id:"configure-an-organization-secret",children:"Configure an organization secret"}),"\n",(0,i.jsxs)(r.p,{children:["To run a scan using ",(0,i.jsx)(r.code,{children:"semgrep ci"}),", Semgrep requires a valid token. When configuring Semgrep as a required workflow for multiple repositories, set up the token as an organization secret."]}),"\n",(0,i.jsx)(r.admonition,{type:"info",children:(0,i.jsxs)(r.p,{children:["If you use a custom ",(0,i.jsx)(r.code,{children:"semgrep.yml"})," configuration, ensure you refer to the secret as ",(0,i.jsx)(r.code,{children:"${{ secrets.SEMGREP_APP_TOKEN }}"})," in your configuration. For the required workflow, this refers to the organization secret."]})}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["Click ",(0,i.jsx)(r.strong,{children:"Create new token"})," on ",(0,i.jsxs)(r.strong,{children:["Settings > ",(0,i.jsx)(r.a,{href:"https://semgrep.dev/orgs/-/settings/tokens",children:"Tokens"})]})," in the Semgrep AppSec Platform."]}),"\n",(0,i.jsxs)(r.li,{children:["Ensure the ",(0,i.jsx)(r.strong,{children:"Agent (CI)"})," scope is checked for the token."]}),"\n",(0,i.jsxs)(r.li,{children:["Copy the token value for use on GitHub, and click ",(0,i.jsx)(r.strong,{children:"Save"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Create an organization secret, following the ",(0,i.jsx)(r.a,{href:"https://docs.github.com/en/enterprise-cloud@latest/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-an-organization",children:"GitHub documentation"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Name the secret ",(0,i.jsx)(r.code,{children:"SEMGREP_APP_TOKEN"}),"."]}),"\n",(0,i.jsx)(r.li,{children:"Paste the value you copied from the Semgrep AppSec Platform."}),"\n",(0,i.jsxs)(r.li,{children:["Select a value for ",(0,i.jsx)(r.strong,{children:"Repository access"})," that matches the repositories you intend to scan with the workflow."]}),"\n",(0,i.jsxs)(r.li,{children:["Click ",(0,i.jsx)(r.strong,{children:"Add secret"}),"."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"create-an-organization-ruleset",children:"Create an organization ruleset"}),"\n",(0,i.jsx)(r.p,{children:"To create the ruleset:"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["Go to your GitHub organization page and click ",(0,i.jsx)(r.strong,{children:"Settings"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Under ",(0,i.jsx)(r.strong,{children:"Code, planning, and automation"}),", click ",(0,i.jsx)(r.strong,{children:"Repository"})," and then ",(0,i.jsx)(r.strong,{children:"Repository rulesets"}),".\n",(0,i.jsx)(r.img,{alt:"Repository rulesets",src:s(70441).A+"",width:"692",height:"612"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Click ",(0,i.jsx)(r.strong,{children:"New branch ruleset"}),"."]}),"\n",(0,i.jsx)(r.li,{children:"Configure the enforcement status, bypass list, target repositories, and target branches based on your organization policies."}),"\n",(0,i.jsxs)(r.li,{children:["Under ",(0,i.jsx)(r.strong,{children:"Branch protections"}),", check the box ",(0,i.jsx)(r.strong,{children:"Require workflows to pass before merging"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Click ",(0,i.jsx)(r.strong,{children:"Add workflow"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["In the ",(0,i.jsx)(r.strong,{children:"Add required workflow"})," modal, select the repository where you placed the Semgrep workflow."]}),"\n",(0,i.jsx)(r.li,{children:"Then, select the branch, tag, or commit to use."}),"\n",(0,i.jsxs)(r.li,{children:["In the ",(0,i.jsx)(r.strong,{children:"Pick a workflow file"})," field, click and select the Semgrep workflow you created in ",(0,i.jsx)(r.a,{href:"#set-up-the-central-semgrep-scan-workflow",children:"Setting up the central Semgrep scan workflow"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Click ",(0,i.jsx)(r.strong,{children:"Add workflow"}),".\n",(0,i.jsx)(r.img,{alt:"Require workflows to pass before merging",src:s(23504).A+"",width:"1952",height:"540"})]}),"\n",(0,i.jsxs)(r.li,{children:["Click ",(0,i.jsx)(r.strong,{children:"Create"})," to create the ruleset."]}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["Refer to GitHub's ",(0,i.jsx)(r.a,{href:"https://docs.github.com/en/enterprise-cloud@latest/organizations/managing-organization-settings/creating-rulesets-for-repositories-in-your-organization",children:"Creating rulesets for repositories in your organization"})," for more general guidance on creating a ruleset for your organization."]}),"\n",(0,i.jsx)(r.h2,{id:"verify-by-creating-a-pull-request",children:"Verify by creating a pull request"}),"\n",(0,i.jsx)(r.p,{children:"After completing the preceding steps, create a pull request in an affected repository to verify the workflow runs as expected."}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsx)(r.li,{children:"Identify a repository targeted by the organization ruleset you created in the previous section."}),"\n",(0,i.jsxs)(r.li,{children:["Create a pull request in that repository, following the ",(0,i.jsx)(r.a,{href:"https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request",children:"GitHub documentation"}),"."]}),"\n",(0,i.jsx)(r.li,{children:"After creating the pull request, review the checks and ensure the Semgrep workflow ran as expected."}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"The required workflow allows merge if the scan is successful, or blocks the pull request if the scan has blocking findings."}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.img,{alt:"Example pull request with successful required workflow",src:s(48602).A+"",width:"1894",height:"1568"})}),"\n",(0,i.jsx)(r.h2,{id:"limitations",children:"Limitations"}),"\n",(0,i.jsxs)(r.p,{children:["Workflows required by repository rulesets are only triggered by ",(0,i.jsx)(r.code,{children:"pull_request"})," or ",(0,i.jsx)(r.code,{children:"merge_group"})," events. When triggered for a pull request, Semgrep runs a ",(0,i.jsx)(r.a,{href:"/deployment/customize-ci-jobs#set-up-diff-aware-scans",children:"diff-aware scan"}),", which only scans changed files."]}),"\n",(0,i.jsxs)(r.p,{children:["To run full scans (scan all files) for your organization's repositories as well, you would need to supplement this setup with another approach, such as ",(0,i.jsx)(r.a,{href:"/docs/kb/semgrep-ci/github-reusable-workflows-semgrep",children:"reusable workflows"}),"."]})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},84521:(e,r,s)=>{s.d(r,{A:()=>o});const o=s.p+"assets/images/semgrep-workflow-repo-0075df268b0254a397ff1395fef2f3cb.png"}}]);