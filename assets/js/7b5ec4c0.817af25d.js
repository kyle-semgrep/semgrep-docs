"use strict";(self.webpackChunkmegadocs=self.webpackChunkmegadocs||[]).push([[71546],{24200:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"kb/semgrep-ci/git-command-errors","title":"Failed to run a git command during a pull request or merge request scan","description":"When running Semgrep in CI with a pull request or merge request as the triggering event, Semgrep runs some additional git commands to determine the behavior for the scan. The scan exits with an error if these commands fail. A message like the following shows in the output:","source":"@site/docs/kb/semgrep-ci/git-command-errors.md","sourceDirName":"kb/semgrep-ci","slug":"/kb/semgrep-ci/git-command-errors","permalink":"/semgrep-docs/kb/semgrep-ci/git-command-errors","draft":false,"unlisted":false,"editUrl":"https://github.com/kyle-semgrep/semgrep-docs/edit/main/docs/kb/semgrep-ci/git-command-errors.md","tags":[{"inline":true,"label":"Git","permalink":"/semgrep-docs/tags/git"},{"inline":true,"label":"Semgrep in CI","permalink":"/semgrep-docs/tags/semgrep-in-ci"}],"version":"current","lastUpdatedAt":1753220396000,"frontMatter":{"tags":["Git","Semgrep in CI"]},"sidebar":"kbSidebar","previous":{"title":"GitLab \\"Job\'s log exceeded limit\\" error","permalink":"/semgrep-docs/kb/semgrep-ci/collect-gitlab-logs"},"next":{"title":"Use GitHub repository rulesets to implement Semgrep","permalink":"/semgrep-docs/kb/semgrep-ci/github-repository-rulesets-semgrep"}}');var r=t(74848),s=t(28453);const o={tags:["Git","Semgrep in CI"]},a="Failed to run a git command during a pull request or merge request scan",c={},l=[{value:"Clone depth is too shallow",id:"clone-depth-is-too-shallow",level:2},{value:"GitHub Actions clone behavior",id:"github-actions-clone-behavior",level:3},{value:"Commit or branch not included in the checkout",id:"commit-or-branch-not-included-in-the-checkout",level:2},{value:"Unable to use <code>--merge-base</code> option to <code>git diff</code> in git versions before 2.30",id:"unable-to-use---merge-base-option-to-git-diff-in-git-versions-before-230",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"failed-to-run-a-git-command-during-a-pull-request-or-merge-request-scan",children:"Failed to run a git command during a pull request or merge request scan"})}),"\n",(0,r.jsxs)(n.p,{children:["When running Semgrep in CI with a pull request or merge request as the triggering event, Semgrep runs some additional ",(0,r.jsx)(n.code,{children:"git"})," commands to determine the behavior for the scan. The scan exits with an error if these commands fail. A message like the following shows in the output:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"[ERROR] Command failed with exit code: 128\n-----\nCommand failed with output:\nfatal: Not a valid object name master\n\n\nFailed to run 'git <command-details>'. Possible reasons:\n\n- the git binary is not available\n- the current working directory is not a git repository\n- the current working directory is not marked as safe\n    (fix with `git config --global --add safe.directory $(pwd)`)\n\nTry running the command yourself to debug the issue.\n"})}),"\n",(0,r.jsx)(n.p,{children:"In addition to the potential reasons included in the message, there are a few other common reasons for git command failure:"}),"\n",(0,r.jsx)(n.h2,{id:"clone-depth-is-too-shallow",children:"Clone depth is too shallow"}),"\n",(0,r.jsx)(n.p,{children:"If a shallow git clone of the repository is used to fetch code, and the branch to be scanned has had many commits added since it was branched off the base branch, Semgrep may not be able to identify the base branch commit to compare the current pull request or merge request branch with. In this case, the command that failed is typically:"}),"\n",(0,r.jsx)("pre",{class:"language-bash",children:(0,r.jsxs)("code",{children:["git merge-base --all ",(0,r.jsx)("span",{className:"placeholder",children:"SHA"})," FETCH_HEAD"]})}),"\n",(0,r.jsx)(n.p,{children:"Semgrep uses the merge-base command to compare the tip of the pull request or merge request branch with the base branch and determine where it branched off, so that it can accurately scan for changes made in the merge request rather than in the base branch."}),"\n",(0,r.jsxs)(n.p,{children:["If there isn't enough history to identify the branch point, this comparison can fail. This is most common if the git clone performed is shallow by default, or if the depth has been set to a small value via command line argument ",(0,r.jsx)(n.code,{children:"--depth"})," or environment variable ",(0,r.jsx)(n.code,{children:"GIT_DEPTH"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"To resolve this issue, increase the clone depth to a larger value. A value such as 20 or 50 is sufficient to capture the information needed for most merge-base calculations."}),"\n",(0,r.jsxs)(n.p,{children:["For GitLab CI, see ",(0,r.jsx)(n.a,{href:"https://docs.gitlab.com/ee/ci/pipelines/settings.html#limit-the-number-of-changes-fetched-during-clone",children:"Limit the number of changes fetched during clone"})," for instructions on configuring this value."]}),"\n",(0,r.jsx)(n.h3,{id:"github-actions-clone-behavior",children:"GitHub Actions clone behavior"}),"\n",(0,r.jsxs)(n.p,{children:["Semgrep has built-in behavior in GitHub Actions to fetch additional commits if the initial clone does not provide sufficient information, so GitHub Actions rarely encounter failures of the ",(0,r.jsx)(n.code,{children:"git merge-base"})," command."]}),"\n",(0,r.jsxs)(n.p,{children:["However, if Semgrep is showing findings in GitHub pull requests that were not introduced by the pull request, you can set the variable ",(0,r.jsx)(n.a,{href:"https://semgrep.dev/docs/semgrep-ci/ci-environment-variables/#semgrep_gha_min_fetch_depth",children:(0,r.jsx)(n.code,{children:"SEMGREP_GHA_MIN_FETCH_DEPTH"})})," to a higher value to improve the accuracy of the merge-base calculation. This value is the starting value used for fetching additional commits. The default is 0."]}),"\n",(0,r.jsx)(n.h2,{id:"commit-or-branch-not-included-in-the-checkout",children:"Commit or branch not included in the checkout"}),"\n",(0,r.jsx)(n.p,{children:"As with clone depth, which refs are checked out can vary depending on the CI environment and configuration. If the branch or ref to scan, or the related baseline ref, is not cloned or not checked out, the command that failed is typically:"}),"\n",(0,r.jsx)("pre",{class:"language-bash",children:(0,r.jsxs)("code",{children:["git cat-file -e ",(0,r.jsx)("span",{className:"placeholder",children:"REF"})]})}),"\n",(0,r.jsxs)(n.p,{children:["with the message ",(0,r.jsx)(n.code,{children:"Not a valid object name REF"}),". This is more common when:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"You are using a standalone CI service, rather than one connected to your SCM."}),"\n",(0,r.jsxs)(n.li,{children:["You have manually set ",(0,r.jsx)(n.code,{children:"--baseline-commit"})," or ",(0,r.jsx)(n.code,{children:"SEMGREP_BASELINE_REF"})," to a commit hash or branch name."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"To resolve this issue, ensure that you have set the baseline ref to a valid ref, and that the ref to scan is checked out in the CI environment."}),"\n",(0,r.jsxs)(n.h2,{id:"unable-to-use---merge-base-option-to-git-diff-in-git-versions-before-230",children:["Unable to use ",(0,r.jsx)(n.code,{children:"--merge-base"})," option to ",(0,r.jsx)(n.code,{children:"git diff"})," in git versions before 2.30"]}),"\n",(0,r.jsxs)(n.p,{children:["When running diff scans against a baseline, Semgrep executes the ",(0,r.jsx)(n.code,{children:"git diff"})," command with a ",(0,r.jsx)(n.code,{children:"--merge-base"})," option to correctly calculate the desired diff based on where the current tree branched from the baseline. This option was added to the ",(0,r.jsx)(n.code,{children:"git diff"})," command in git 2.30. If you are running an earlier version of ",(0,r.jsx)(n.code,{children:"git"}),", this command may fail."]}),"\n",(0,r.jsx)(n.p,{children:"To run the scan successfully:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"If possible, update your git version."}),"\n",(0,r.jsx)(n.li,{children:"If that's not possible, consider executing the scan using the Semgrep Docker container, which includes a recent version of git."}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var i=t(96540);const r={},s=i.createContext(r);function o(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);