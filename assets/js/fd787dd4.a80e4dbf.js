"use strict";(self.webpackChunkmegadocs=self.webpackChunkmegadocs||[]).push([[68433],{7058:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"kb/rules/using-pattern-not-inside","title":"My rule with pattern-not doesn\'t work: using pattern-not-inside","description":"Learn how to fix issues with `pattern-not` when excluding cases in custom rules.","source":"@site/docs/kb/rules/using-pattern-not-inside.md","sourceDirName":"kb/rules","slug":"/kb/rules/using-pattern-not-inside","permalink":"/semgrep-docs/kb/rules/using-pattern-not-inside","draft":false,"unlisted":false,"editUrl":"https://github.com/kyle-semgrep/semgrep-docs/edit/main/docs/kb/rules/using-pattern-not-inside.md","tags":[{"inline":true,"label":"Semgrep Community Edition","permalink":"/semgrep-docs/tags/semgrep-community-edition"},{"inline":true,"label":"Semgrep Rules","permalink":"/semgrep-docs/tags/semgrep-rules"}],"version":"current","lastUpdatedAt":1753214405000,"frontMatter":{"description":"Learn how to fix issues with `pattern-not` when excluding cases in custom rules.","tags":["Semgrep Community Edition","Semgrep Rules"],"append_help_link":true},"sidebar":"kbSidebar","previous":{"title":"How does Semgrep assign severity levels to rules?","permalink":"/semgrep-docs/kb/rules/understand-severities"},"next":{"title":"Use the Semgrep rule schema to write rules in VS Code","permalink":"/semgrep-docs/kb/rules/using-semgrep-rule-schema-in-vscode"}}');var r=t(74848),i=t(28453);const a={description:"Learn how to fix issues with `pattern-not` when excluding cases in custom rules.",tags:["Semgrep Community Edition","Semgrep Rules"],append_help_link:!0},o="My rule with pattern-not doesn't work: using pattern-not-inside",c={},d=[{value:"Background",id:"background",level:2},{value:"Example",id:"example",level:2},{value:"Further information",id:"further-information",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsxs)(n.h1,{id:"my-rule-with-pattern-not-doesnt-work-using-pattern-not-inside",children:["My rule with ",(0,r.jsx)(n.code,{children:"pattern-not"})," doesn't work: using ",(0,r.jsx)(n.code,{children:"pattern-not-inside"})]})}),"\n",(0,r.jsxs)(n.p,{children:["One common issue when writing custom rules involves the unsuccessful exclusion of cases using ",(0,r.jsx)(n.code,{children:"pattern-not"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["If you are trying to exclude a specific case where a pattern is unacceptable unless it is accompanied by another pattern, try ",(0,r.jsx)(n.code,{children:"pattern-not-inside"})," instead of ",(0,r.jsx)(n.code,{children:"pattern-not"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"background",children:"Background"}),"\n",(0,r.jsx)(n.p,{children:"In Semgrep, a pattern that's inside another pattern can mean one of two things:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The pattern is wholly within an outer pattern"}),"\n",(0,r.jsx)(n.li,{children:"The pattern is at the same level as another pattern, but includes less code"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["In other words, using ",(0,r.jsx)(n.code,{children:"pattern-not"}),' in your rule means that Semgrep expects the matches to be the same "size" (same amount of code), and does not match if that\'s not the case.']}),"\n",(0,r.jsx)(n.h2,{id:"example",children:"Example"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.a,{href:"https://semgrep.dev/docs/writing-rules/rule-ideas/#systematize-project-specific-coding-patterns",children:"example rule"})," ",(0,r.jsx)(n.code,{children:"find-unverified-transactions"})," is a good example: ",(0,r.jsx)(n.code,{children:"make_transaction($T)"})," is acceptable only if ",(0,r.jsx)(n.code,{children:"verify_transaction($T)"})," is also present."]}),"\n",(0,r.jsxs)(n.p,{children:["To successfully match the target code, the rule uses ",(0,r.jsx)(n.code,{children:"pattern"})," and ",(0,r.jsx)(n.code,{children:"pattern-not"}),":"]}),"\n",(0,r.jsx)("iframe",{src:"https://semgrep.dev/embed/editor?snippet=Nr3z",title:"pattern-not rule for unverified transactions",width:"100%",height:"432px",frameBorder:"0"}),"\n",(0,r.jsx)(n.p,{children:"But this rule is redundant. Both pattern clauses contain:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yml",children:"public $RETURN $METHOD(...){\n  ...\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["However, if you refactor the rule by pulling the container out and using ",(0,r.jsx)(n.code,{children:"pattern-inside"}),", the rule doesn't work -- ",(0,r.jsx)(n.a,{href:"https://semgrep.dev/playground/s/KZOd?editorMode=advanced",children:"try it out"})," if you like!"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yml",children:"rules:\n  - id: find-unverified-transactions-inside\n    patterns:\n      - pattern-inside: |\n          $RETURN $METHOD(...) {\n            ...\n          }\n      - pattern: |\n          ...\n          make_transaction($T);\n          ...\n      - pattern-not: |\n          ...\n          verify_transaction($T);\n          ...\n          make_transaction($T);\n          ...\n"})}),"\n",(0,r.jsxs)(n.p,{children:["With an understanding of how ",(0,r.jsx)(n.code,{children:"pattern-not"})," operates, you can see that this rule fails because the matches are not the same size. The ",(0,r.jsx)(n.code,{children:"pattern-not"}),' match is at the same level, but it is "larger" (contains more code).']}),"\n",(0,r.jsxs)(n.p,{children:["If you switch to ",(0,r.jsx)(n.code,{children:"pattern-not-inside"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yml",children:"- pattern-not-inside: |\n    ...\n    verify_transaction($T);\n    ...\n    make_transaction($T);\n    ...\n"})}),"\n",(0,r.jsx)(n.p,{children:"The rule successfully matches the example code."}),"\n",(0,r.jsx)(n.h2,{id:"further-information",children:"Further information"}),"\n",(0,r.jsxs)(n.p,{children:["See this video for more information about the difference between ",(0,r.jsx)(n.code,{children:"pattern-not"})," and  ",(0,r.jsx)(n.code,{children:"pattern-not-inside"}),"."]}),"\n",(0,r.jsx)("iframe",{class:"yt_embed",width:"100%",height:"432px",src:"https://www.youtube.com/embed/JBEKaTTrhTY?si=aw7Sv1bz8l-a-4ZR",frameborder:"0",allowfullscreen:!0})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var s=t(96540);const r={},i=s.createContext(r);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);