"use strict";(self.webpackChunkmegadocs=self.webpackChunkmegadocs||[]).push([[68988],{28453:(e,s,r)=>{r.d(s,{R:()=>a,x:()=>l});var t=r(96540);const n={},i=t.createContext(n);function a(e){const s=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),t.createElement(i.Provider,{value:s},e.children)}},86205:(e,s,r)=>{r.r(s),r.d(s,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"semgrep-secrets/rules","title":"Custom rules","description":"Learn about Semgrep Secrets rules.","source":"@site/docs/semgrep-secrets/rules.md","sourceDirName":"semgrep-secrets","slug":"/semgrep-secrets/rules","permalink":"/semgrep-docs/semgrep-secrets/rules","draft":false,"unlisted":false,"editUrl":"https://github.com/kyle-semgrep/semgrep-docs/edit/main/docs/semgrep-secrets/rules.md","tags":[{"inline":true,"label":"Semgrep Secrets","permalink":"/semgrep-docs/tags/semgrep-secrets"},{"inline":true,"label":"Rule writing","permalink":"/semgrep-docs/tags/rule-writing"}],"version":"current","lastUpdatedAt":1753214405000,"frontMatter":{"slug":"rules","append_help_link":true,"title":"Custom rules","hide_title":true,"description":"Learn about Semgrep Secrets rules.","tags":["Semgrep Secrets","Rule writing"]},"sidebar":"rulewritingSidebar","previous":{"title":"SAST and rule-writing glossary","permalink":"/semgrep-docs/writing-rules/glossary"},"next":{"title":"Custom validators","permalink":"/semgrep-docs/semgrep-secrets/validators"}}');var n=r(74848),i=r(28453);const a={slug:"rules",append_help_link:!0,title:"Custom rules",hide_title:!0,description:"Learn about Semgrep Secrets rules.",tags:["Semgrep Secrets","Rule writing"]},l="Semgrep Secrets rule structure and sample",d={},o=[{value:"Write a rule",id:"write-a-rule",level:2},{value:"Create a YAML file",id:"create-a-yaml-file",level:3},{value:"Use Semgrep Editor",id:"use-semgrep-editor",level:3},{value:"Sample rule",id:"sample-rule",level:2},{value:"Subkeys under the <code>metadata</code> key",id:"subkeys-under-the-metadata-key",level:3},{value:"Subkeys under the <code>patterns</code> key",id:"subkeys-under-the-patterns-key",level:3},{value:"Subkeys under the <code>validators</code> and <code>http</code> keys",id:"subkeys-under-the-validators-and-http-keys",level:3},{value:"Metavariable binding",id:"metavariable-binding",level:2},{value:"Differences between Semgrep Secrets rules and Semgrep Registry rules",id:"differences-between-semgrep-secrets-rules-and-semgrep-registry-rules",level:2}];function c(e){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.header,{children:(0,n.jsx)(s.h1,{id:"semgrep-secrets-rule-structure-and-sample",children:"Semgrep Secrets rule structure and sample"})}),"\n",(0,n.jsx)(s.p,{children:"This article walks you through writing, publishing, and using Semgrep Secrets rules. It also demonstrates what a sample Semgrep Secrets rule looks like, with subsequent sections describing the key-value pairs in the context of a Semgrep Secrets rule."}),"\n",(0,n.jsx)(s.h2,{id:"write-a-rule",children:"Write a rule"}),"\n",(0,n.jsx)(s.p,{children:"There are two ways to write a rule for Semgrep Secrets:"}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsx)(s.li,{children:"Create a YAML file."}),"\n",(0,n.jsx)(s.li,{children:"Use the Semgrep editor."}),"\n"]}),"\n",(0,n.jsx)(s.h3,{id:"create-a-yaml-file",children:"Create a YAML file"}),"\n",(0,n.jsxs)(s.p,{children:["If you're familiar with Semgrep's rules syntax, including the ",(0,n.jsx)(s.a,{href:"/semgrep-secrets/validators",children:"validator syntax"}),", you can create a YAML file containing your rules. When you're done, ",(0,n.jsx)(s.a,{href:"/writing-rules/private-rules/",children:"publish your rules for use with your organization"}),"."]}),"\n",(0,n.jsxs)(s.p,{children:["If you want to keep your rules file local, you must pass in the ",(0,n.jsx)(s.code,{children:"--allow-untrusted-validators"})," flag when calling ",(0,n.jsx)(s.code,{children:"semgrep ci"})," from the CLI."]}),"\n",(0,n.jsx)(s.h3,{id:"use-semgrep-editor",children:"Use Semgrep Editor"}),"\n",(0,n.jsx)(s.p,{children:"The Semgrep Editor, available in Semgrep AppSec Platform, can help you write custom Semgrep Secrets rules. To pull up a sample rule that you can modify:"}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsx)(s.li,{children:"Sign in to Semgrep AppSec Platform."}),"\n",(0,n.jsxs)(s.li,{children:["Go to ",(0,n.jsx)(s.strong,{children:"Rules > Editor"}),"."]}),"\n",(0,n.jsxs)(s.li,{children:["Click the ",(0,n.jsx)(s.strong,{children:"+"})," icon and, under ",(0,n.jsx)(s.strong,{children:"Secrets"}),", select ",(0,n.jsx)(s.strong,{children:"HTTP validators"}),"."]}),"\n"]}),"\n",(0,n.jsxs)(s.p,{children:["Semgrep Editor allows you to modify the sample rule and run it against test code to ensure it functions as expected. When you finish making changes, click ",(0,n.jsx)(s.strong,{children:"Save"})," to proceed."]}),"\n",(0,n.jsx)(s.admonition,{type:"info",children:(0,n.jsx)(s.p,{children:"Custom validator rules are private to your organization. They are not available to the Semgrep Community."})}),"\n",(0,n.jsx)(s.p,{children:"To run a specific rule when invoking Semgrep from the CLI:"}),"\n",(0,n.jsxs)(s.ol,{children:["\n",(0,n.jsx)(s.li,{children:"Sign in to Semgrep AppSec Platform."}),"\n",(0,n.jsxs)(s.li,{children:["Go to ",(0,n.jsx)(s.strong,{children:"Rules > Editor"}),"."]}),"\n",(0,n.jsx)(s.li,{children:"Open up your rule."}),"\n",(0,n.jsxs)(s.li,{children:["Click ",(0,n.jsx)(s.strong,{children:"Add to Policy"})," and select your mode: Monitor, Comment, or Blocking."]}),"\n",(0,n.jsxs)(s.li,{children:["In the CLI, start a scan by running ",(0,n.jsx)(s.code,{children:"semgrep ci"}),"."]}),"\n"]}),"\n",(0,n.jsx)(s.h2,{id:"sample-rule",children:"Sample rule"}),"\n",(0,n.jsx)(s.p,{children:"The following sample rule detects a leaked GitHub personal access token (PAT):"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:"rules:\n- id: github_example\n  message: >-\n    This is an example rule, that performs validation against github.com\n  severity: WARNING\n  languages:\n  - regex\n  validators:\n  - http:\n      request:\n        headers:\n          Authorization: Bearer $REGEX\n          Host: api.github.com\n          User-Agent: Semgrep\n        method: GET\n        url: https://api.github.com/user\n      response:\n      - match:\n        - status-code: 200\n        result:\n          validity: valid\n      - match:\n        - status-code: 401\n        result:\n          validity: invalid\n  patterns:\n  - patterns:\n    - pattern-regex: (?<REGEX>\\b((ghp|gho|ghu|ghs|ghr|github_pat)_[a-zA-Z0-9_]{36,255})\\b)\n    - focus-metavariable: $REGEX\n    - metavariable-analysis:\n        analyzer: entropy\n        metavariable: $REGEX\n"})}),"\n",(0,n.jsx)(s.p,{children:"This can also be done in any Semgrep-supported language:"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:'rules:\n- id: github_example\n  message: >-\n    This is an example rule that performs validation against github.com\n  severity: WARNING\n  languages:\n  - javascript\n  - typescript\n  validators:\n  - http:\n      request:\n        headers:\n          Authorization: Bearer $REGEX\n          Host: api.github.com\n          User-Agent: Semgrep\n        method: GET\n        url: https://api.github.com/user\n      response:\n      - match:\n        - status-code: 200\n        result:\n          validity: valid\n      - match:\n        - status-code: 401\n        result:\n          validity: invalid\n  patterns:\n  - patterns:\n    - pattern: |\n        "$R"\n    - metavariable-pattern:\n        metavariable: $R\n        patterns:\n          - pattern-regex: (?<REGEX>\\b((ghp|gho|ghu|ghs|ghr|github_pat)_[a-zA-Z0-9_]{36,255})\\b)\n    - focus-metavariable: $REGEX\n    - metavariable-analysis:\n        analyzer: entropy\n        metavariable: $REGEX\n'})}),"\n",(0,n.jsxs)(s.h3,{id:"subkeys-under-the-metadata-key",children:["Subkeys under the ",(0,n.jsx)(s.code,{children:"metadata"})," key"]}),"\n",(0,n.jsx)(s.p,{children:"These subkeys provide context to both you and other end-users, as well as to\nSemgrep."}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:"  ...\n  metadata:\n    ...\n    secret_type: GitHub\n    technology:\n    - secrets\n  ...\n"})}),"\n",(0,n.jsxs)(s.table,{children:[(0,n.jsx)(s.thead,{children:(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.th,{children:"Key"}),(0,n.jsx)(s.th,{children:"Description"})]})}),(0,n.jsxs)(s.tbody,{children:[(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"secret_type"})}),(0,n.jsx)(s.td,{children:'Defines the name of the service or the type of secret. When writing a custom validator, set this value to a descriptive name to help identify it when triaging secrets. Examples of secret types include "Slack," "Asana," and other common service names.'})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"technology"})}),(0,n.jsxs)(s.td,{children:["Set this to ",(0,n.jsx)(s.code,{children:"secrets"})," to identify the rule as a Secrets rule."]})]})]})]}),"\n",(0,n.jsxs)(s.h3,{id:"subkeys-under-the-patterns-key",children:["Subkeys under the ",(0,n.jsx)(s.code,{children:"patterns"})," key"]}),"\n",(0,n.jsx)(s.p,{children:"These subkeys identify the token to analyze in a given match."}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:"  ...\n  patterns:\n  ...\n  - pattern-regex: (?<REGEX>\\b((ghp|gho|ghu|ghs|ghr|github_pat)_[a-zA-Z0-9_]{36,255})\\b)\n  - focus-metavariable: $REGEX\n  - metavariable-analysis:\n      analyzer: entropy\n      metavariable: $REGEX\n  ..\n"})}),"\n",(0,n.jsxs)(s.table,{children:[(0,n.jsx)(s.thead,{children:(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.th,{children:"Key"}),(0,n.jsx)(s.th,{children:"Description"})]})}),(0,n.jsxs)(s.tbody,{children:[(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"pattern-regex"})}),(0,n.jsx)(s.td,{children:"Searches for a regular expression and assigns it to the named capture group regex, which is then used as $REGEX."})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"focus_metavariable"})}),(0,n.jsx)(s.td,{children:"This key enables the rule to define a metavariable upon which Semgrep can perform further analysis, such as entropy analysis."})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"metavariable_analysis"})}),(0,n.jsxs)(s.td,{children:["Under ",(0,n.jsx)(s.code,{children:"metavariable_analysis"}),", you can define additional keys: ",(0,n.jsx)(s.code,{children:"analyzer"})," and ",(0,n.jsx)(s.code,{children:"metavariable"}),". These specify the kind of analysis Semgrep performs and on what variable."]})]})]})]}),"\n",(0,n.jsx)(s.admonition,{type:"tip",children:(0,n.jsxs)(s.p,{children:["For more information, see the rule syntax for ",(0,n.jsxs)(s.a,{href:"/writing-rules/rule-syntax/#focus-metavariable",children:[(0,n.jsx)("i",{class:"fa-regular fa-file-lines"})," Focus\nmetavariable"]}),"."]})}),"\n",(0,n.jsxs)(s.h3,{id:"subkeys-under-the-validators-and-http-keys",children:["Subkeys under the ",(0,n.jsx)(s.code,{children:"validators"})," and ",(0,n.jsx)(s.code,{children:"http"})," keys"]}),"\n",(0,n.jsxs)(s.p,{children:["The ",(0,n.jsx)(s.code,{children:"validators"})," key uses a list of keys to define the validator function. In\nparticular, the ",(0,n.jsx)(s.code,{children:"http"})," key defines how the rule forms a request object and what\nresponse is expected for valid and invalid states. Although some rules do not use a ",(0,n.jsx)(s.code,{children:"validators"})," key, most Secrets rules use it."]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",children:"  ...\n  validators:\n  - http:\n      request:\n        headers:\n          Authorization: Bearer $REGEX\n          Host: api.github.com\n          User-Agent: Semgrep\n        method: GET\n        url: https://api.github.com/user\n      response:\n        - match:\n          - status-code: '200'\n          result:\n            validity: valid\n        - match:\n          - status-code: '404'\n          result:\n            validity: invalid\n"})}),"\n",(0,n.jsxs)(s.table,{children:[(0,n.jsx)(s.thead,{children:(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.th,{children:"Key"}),(0,n.jsx)(s.th,{children:"Description"})]})}),(0,n.jsxs)(s.tbody,{children:[(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"request"})}),(0,n.jsx)(s.td,{children:"This key and its subkeys describe the request object and the URL to send the request object to."})]}),(0,n.jsxs)(s.tr,{children:[(0,n.jsx)(s.td,{children:(0,n.jsx)(s.code,{children:"response"})}),(0,n.jsxs)(s.td,{children:["This key and its subkeys determine ",(0,n.jsx)(s.strong,{children:"validation status"}),". Semgrep Secrets identifies a validation status through HTTP status code ",(0,n.jsx)(s.strong,{children:"and"})," other key-value pairs. For example, a rule may require a 200 status code ",(0,n.jsx)(s.strong,{children:"and"})," a ",(0,n.jsx)(s.code,{children:'"message": "ok"'})," in the response body for the matching secret to be considered ",(0,n.jsx)(s.strong,{children:"Confirmed valid"}),"."]})]})]})]}),"\n",(0,n.jsx)(s.admonition,{type:"tip",children:(0,n.jsxs)(s.p,{children:["See ",(0,n.jsxs)(s.a,{href:"/semgrep-secrets/validators",children:[(0,n.jsx)("i",{class:"fa-regular fa-file-lines"})," Validators"]})," for more information."]})}),"\n",(0,n.jsx)(s.h2,{id:"metavariable-binding",children:"Metavariable binding"}),"\n",(0,n.jsx)(s.p,{children:"Semgrep Secrets can use metavariables. Metavariables allow Semgrep Secrets to reuse matched information from your code in its validators. An example of a metavariable is as follows:"}),"\n",(0,n.jsx)("iframe",{title:"Message displays metavariable content",src:"https://semgrep.dev/embed/editor?snippet=JDzRR",width:"100%",height:"432px",frameBorder:"0"}),"\n",(0,n.jsx)("br",{}),"\n",(0,n.jsxs)(s.p,{children:["When you click ",(0,n.jsx)(s.strong,{children:"Run"}),", the content from the metavariable ",(0,n.jsx)(s.code,{children:"$HELLO"})," displays as ",(0,n.jsx)(s.code,{children:"This content is now reusable in validators"}),". If this were a Secrets rule, Semgrep Secrets could use this to call the appropriate service to determine if the secret is active."]}),"\n",(0,n.jsx)(s.h2,{id:"differences-between-semgrep-secrets-rules-and-semgrep-registry-rules",children:"Differences between Semgrep Secrets rules and Semgrep Registry rules"}),"\n",(0,n.jsx)(s.p,{children:"The Semgrep Registry includes SAST rules that can detect secrets to a certain\nextent. You can run these rules in Semgrep Code (Semgrep's SAST analyzer), or\neven write your own custom secret-detecting SAST rules, but with the following\ndifferences:"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsxs)(s.li,{children:["Semgrep Code does not run a validator function against these rules, resulting in less accurate results.","\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"Because the results are less accurate, these rules are not suitable as criteria to block a PR or MR."}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(s.li,{children:"The UI for Semgrep Code is tailored to SAST triage and does not include filtering functions for valid or invalid tokens."}),"\n",(0,n.jsx)(s.li,{children:"Existing Semgrep Pro rules that detect secrets are transitioning from Semgrep Code to Semgrep Secrets. By transitioning these rules, improvements, such as validator functions, can be added to the rules when they are run in Semgrep Secrets."}),"\n",(0,n.jsx)(s.li,{children:"You can write your own custom validator functions and run them in Semgrep Secrets for custom services or use cases."}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}}}]);