"use strict";(self.webpackChunkmegadocs=self.webpackChunkmegadocs||[]).push([[47951],{28453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>a});var s=r(96540);const i={},t=s.createContext(i);function o(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(t.Provider,{value:n},e.children)}},43732:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>a,metadata:()=>s,toc:()=>u});const s=JSON.parse('{"id":"kb/semgrep-ci/azure-self-hosted-ubuntu","title":"Semgrep with self-hosted Ubuntu runners in Azure Pipelines","description":"Run Semgrep on self-hosted Ubuntu runners in Azure DevOps.","source":"@site/docs/kb/semgrep-ci/azure-self-hosted-ubuntu.md","sourceDirName":"kb/semgrep-ci","slug":"/kb/semgrep-ci/azure-self-hosted-ubuntu","permalink":"/semgrep-docs/kb/semgrep-ci/azure-self-hosted-ubuntu","draft":false,"unlisted":false,"editUrl":"https://github.com/kyle-semgrep/semgrep-docs/edit/main/docs/kb/semgrep-ci/azure-self-hosted-ubuntu.md","tags":[{"inline":true,"label":"Azure Pipelines","permalink":"/semgrep-docs/tags/azure-pipelines"}],"version":"current","lastUpdatedAt":1752262761000,"frontMatter":{"tags":["Azure Pipelines"],"description":"Run Semgrep on self-hosted Ubuntu runners in Azure DevOps."},"sidebar":"kbSidebar","previous":{"title":"Semgrep in CI","permalink":"/semgrep-docs/kb/semgrep-ci"},"next":{"title":"Running Semgrep using templates in Azure Pipelines","permalink":"/semgrep-docs/kb/semgrep-ci/azure-using-templates-with-semgrep"}}');var i=r(74848),t=r(28453),o=r(93138);const a={tags:["Azure Pipelines"],description:"Run Semgrep on self-hosted Ubuntu runners in Azure DevOps."},l="Semgrep with self-hosted Ubuntu runners in Azure Pipelines",c={},u=[{value:"Using pipx",id:"using-pipx",level:2},{value:"Prepare your runner",id:"prepare-your-runner",level:3},{value:"Create your configuration",id:"create-your-configuration",level:3},...o.RM,{value:"Using pip with a virtual environment",id:"using-pip-with-a-virtual-environment",level:2},{value:"Prepare your runner",id:"prepare-your-runner-1",level:3},{value:"Create your configuration",id:"create-your-configuration-1",level:3},...o.RM];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"semgrep-with-self-hosted-ubuntu-runners-in-azure-pipelines",children:"Semgrep with self-hosted Ubuntu runners in Azure Pipelines"})}),"\n",(0,i.jsxs)(n.p,{children:["Semgrep provides a ",(0,i.jsx)(n.a,{href:"/docs/semgrep-ci/sample-ci-configs#azure-pipelines",children:"sample configuration for Azure-hosted runners"}),". If you use self-hosted Ubuntu Linux runners, you have significantly more control over their configuration, but as a result, they require additional preparation and configuration to run Semgrep."]}),"\n",(0,i.jsx)(n.p,{children:"This guide adds two approaches to configuring self-hosted runners that use Ubuntu (the default self-hosted option for Azure DevOps Linux runners):"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#using-pipx",children:"Using pipx"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#using-pip-with-a-virtual-environment",children:"Using pip with a virtual environment"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"using-pipx",children:"Using pipx"}),"\n",(0,i.jsxs)(n.p,{children:["While the sample configuration uses ",(0,i.jsx)(n.code,{children:"pip"}),", this approach uses ",(0,i.jsx)(n.code,{children:"pipx"}),", which avoids issues with system-managed Python vs user-installed Python."]}),"\n",(0,i.jsx)(n.h3,{id:"prepare-your-runner",children:"Prepare your runner"}),"\n",(0,i.jsx)(n.p,{children:"Access the runner and execute the following commands:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ sudo apt update\n$ sudo apt install pipx\n$ pipx ensurepath\n"})}),"\n",(0,i.jsx)(n.p,{children:"After completing the commands:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Start a new shell session, so that the changes from ",(0,i.jsx)(n.code,{children:"pipx ensurepath"})," are available."]}),"\n",(0,i.jsxs)(n.li,{children:["Ensure the ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/linux-agent?view=azure-devops",children:"Azure DevOps agent"})," is set up and running."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"create-your-configuration",children:"Create your configuration"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Follow the steps provided in the ",(0,i.jsx)(n.a,{href:"/docs/semgrep-ci/sample-ci-configs#azure-pipelines",children:"sample configuration for Azure-hosted runners"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Add the following snippet to the ",(0,i.jsx)(n.code,{children:"azure-pipelines.yml"})," for the repository."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'variables:\n- group: Semgrep_Variables\n\npool:\n  name: Default\n\nsteps:\n- checkout: self\n  clean: true\n  fetchDepth: 20\n  persistCredentials: true\n- script: |\n    pipx install semgrep\n    if [ $(Build.SourceBranchName) = "master" ]; then\n        echo "Semgrep full scan"\n        semgrep ci\n    elif [ $(System.PullRequest.PullRequestId) -ge 0 ]; then\n        echo "Semgrep diff scan"\n        git fetch origin master:origin/master\n        export SEMGREP_PR_ID=$(System.PullRequest.PullRequestId)\n        export SEMGREP_BASELINE_REF=\'origin/master\'\n        semgrep ci\n    fi\n  env:\n    SEMGREP_APP_TOKEN: $(SEMGREP_APP_TOKEN)\n'})}),"\n",(0,i.jsx)(n.admonition,{title:"Customizing the configuration",type:"info",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If your self-hosted runner ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/pools-queues?view=azure-devops&tabs=yaml%2Cbrowser",children:"agent pool"})," has a different name, update the ",(0,i.jsx)(n.code,{children:"name"})," key under ",(0,i.jsx)(n.code,{children:"pool"})," to match the desired agent pool."]}),"\n",(0,i.jsxs)(n.li,{children:["If your default branch is not called ",(0,i.jsx)(n.code,{children:"master"}),", update the references to ",(0,i.jsx)(n.code,{children:"master"})," to match the name of your default branch."]}),"\n"]})}),"\n",(0,i.jsx)(o.Ay,{}),"\n",(0,i.jsx)(n.h2,{id:"using-pip-with-a-virtual-environment",children:"Using pip with a virtual environment"}),"\n",(0,i.jsx)(n.h3,{id:"prepare-your-runner-1",children:"Prepare your runner"}),"\n",(0,i.jsxs)(n.p,{children:["This approach uses built-in Azure DevOps tasks, including ",(0,i.jsx)(n.code,{children:"UsePythonVersion"})," and ",(0,i.jsx)(n.code,{children:"Bash"}),", and uses a virtual environment to install ",(0,i.jsx)(n.code,{children:"pip"}),", another approach that prevents issues with system-managed Python vs user-installed Python."]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Ensure you have a pre-installed and configured compatible version of Python 3, following ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/pipelines/tasks/reference/use-python-version-v0?view=azure-pipelines#how-can-i-configure-a-self-hosted-agent-to-use-this-task",children:"the instructions for UsePythonVersion for self-hosted runners"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Ensure the ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/linux-agent?view=azure-devops",children:"Azure DevOps agent"})," is set up and running."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"create-your-configuration-1",children:"Create your configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Add the following snippet to the ",(0,i.jsx)(n.code,{children:"azure-pipelines.yml"})," for the repository."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"variables:\n- group: Semgrep_Variables\n\npool:\n  name: Default\n\nsteps:\n  - checkout: self\n    clean: true\n    persistCredentials: true\n  - task: UsePythonVersion@0\n    displayName: 'Use Python 3.12'\n    inputs:\n      versionSpec: 3.12\n  - task: Bash@3\n    env:\n      SEMGREP_APP_TOKEN: $(SEMGREP_APP_TOKEN)\n    inputs:\n      targetType: 'inline'\n      script: |\n        python3 -m venv .venv\n        source .venv/bin/activate\n        python3 -m pip install --upgrade pip\n        pip install semgrep\n\n        if [ $(Build.SourceBranchName) = \"master\" ]; then\n          export SEMGREP_BRANCH=$(Build.SourceBranchName)\n          echo \"Semgrep full scan of master\"\n          semgrep ci\n        elif [ $(System.PullRequest.PullRequestId) -ge 0 ]; then\n          echo \"Semgrep diff scan\"\n          git fetch origin master:origin/master\n          export SEMGREP_PR_ID=$(System.PullRequest.PullRequestId)\n          export SEMGREP_BASELINE_REF='origin/master'\n          semgrep ci\n       fi\n"})}),"\n",(0,i.jsx)(n.admonition,{title:"Customizing the configuration",type:"info",children:(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If your self-hosted runner ",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/pools-queues?view=azure-devops&tabs=yaml%2Cbrowser",children:"agent pool"})," has a different name, update the ",(0,i.jsx)(n.code,{children:"name"})," key under ",(0,i.jsx)(n.code,{children:"pool"})," to match the desired agent pool."]}),"\n",(0,i.jsxs)(n.li,{children:["If your default branch is not called ",(0,i.jsx)(n.code,{children:"master"}),", update the references to ",(0,i.jsx)(n.code,{children:"master"})," to match the name of your default branch."]}),"\n"]})}),"\n",(0,i.jsx)(o.Ay,{})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},93138:(e,n,r)=>{r.d(n,{Ay:()=>a,RM:()=>t});var s=r(74848),i=r(28453);const t=[{value:"Set environment variables in Azure Pipelines",id:"set-environment-variables-in-azure-pipelines",level:3}];function o(e){const n={a:"a",code:"code",h3:"h3",li:"li",ol:"ol",p:"p",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"set-environment-variables-in-azure-pipelines",children:"Set environment variables in Azure Pipelines"}),"\n",(0,s.jsxs)(n.p,{children:["Semgrep minimally requires the variable ",(0,s.jsx)(n.code,{children:"SEMGREP_APP_TOKEN"})," in order to report results to the platform, and other variables may be helpful as well. To set these variables in Azure Pipelines:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Set up a ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/pipelines/library/variable-groups?view=azure-devops&tabs=classic",children:"variable group"})," called ",(0,s.jsx)(n.code,{children:"Semgrep_Variables"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Set ",(0,s.jsx)(n.code,{children:"SEMGREP_APP_TOKEN"})," in the variable group, following the steps for ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/pipelines/process/set-secret-variables?view=azure-devops&tabs=yaml%2Cbash#set-a-secret-variable-in-a-variable-group",children:"secret variables"}),". The variable is mapped into the ",(0,s.jsx)(n.code,{children:"env"})," in the provided config."]}),"\n",(0,s.jsxs)(n.li,{children:["Optional: Add the following environment variables to the group if you aren't seeing hyperlinks to the code that generated a finding, or if you are not receiving PR or MR comments. Review the use of these variables at ",(0,s.jsx)(n.a,{href:"https://semgrep.dev/docs/semgrep-ci/ci-environment-variables#environment-variables-for-creating-hyperlinks-in-semgrep-appsec-platform",children:"Environment variables for creating hyperlinks in Semgrep AppSec Platform"}),".These variables are not sensitive and do not need to be secret variables.","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"SEMGREP_REPO_NAME"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"SEMGREP_REPO_URL"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"SEMGREP_BRANCH"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"SEMGREP_COMMIT"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"SEMGREP_JOB_URL"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Set variables for diff-aware scanning. The provided config sets ",(0,s.jsx)(n.code,{children:"SEMGREP_PR_ID"})," to the system variable ",(0,s.jsx)(n.code,{children:"System.PullRequest.PullRequestId"})," and ",(0,s.jsx)(n.code,{children:"SEMGREP_BASELINE_REF"})," to ",(0,s.jsx)(n.code,{children:"origin/master"})," within the ",(0,s.jsx)(n.code,{children:"script"})," section of the config. The value of ",(0,s.jsx)(n.code,{children:"SEMGREP_BASELINE_REF"})," is typically your trunk or default branch, so if you use a different branch than master, update the name accordingly. as ",(0,s.jsx)(n.code,{children:"main"})," or ",(0,s.jsx)(n.code,{children:"master"}),".","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["If you prefer not to implement diff-aware scanning, you can skip setting these variables and remove the ",(0,s.jsx)(n.code,{children:"elif"})," section of the ",(0,s.jsx)(n.code,{children:"script"})," step."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["For diff-aware scans: add a ",(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/devops/repos/git/branch-policies?view=azure-devops&tabs=browser#build-validation",children:"build validation policy"}),". Adding and enabling a branch policy for build validation is required to trigger Azure Pipelines on pull requests."]}),"\n"]})]})}function a(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}}}]);